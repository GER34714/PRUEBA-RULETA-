<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ruleta Casino</title>
  <style>
    body {
      margin: 0;
      font-family: Arial Black, sans-serif;
      text-align: center;
      color: #0ff;
      background: url('https://iili.io/KfreSig.md.webp') no-repeat center center fixed;
      background-size: cover;
      text-shadow: 0 0 5px #000, 0 0 8px #000;
    }

    h1 {
      margin: 10px 0;
      font-size: 22px;
      color: #ff0;
      text-shadow: 0 0 10px #000, 0 0 15px #f0f;
    }

    #wheelContainer {
      position: relative;
      width: 70vw;
      max-width: 250px;
      margin: 0 auto 10px auto;
      background: transparent;
    }

    canvas#wheelCanvas, canvas#confetti {
      background: transparent;
      display: block;
      margin: 0 auto;
    }

    button {
      background: linear-gradient(45deg, #ff0, #f0f);
      border: none;
      padding: 12px 20px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 0 10px #000;
      transition: transform 0.2s;
    }
    button:hover {
      transform: scale(1.1);
    }

    #result {
      font-size: 18px;
      margin-top: 10px;
      color: #fff;
    }

    #cashier {
      font-size: 16px;
      margin-top: 5px;
      color: #0f0;
    }
  </style>
</head>
<body>
  <h1>ðŸŽ° Gira la Ruleta ðŸŽ°</h1>

  <div id="wheelContainer">
    <canvas id="wheelCanvas" width="250" height="250"></canvas>
    <canvas id="confetti" width="250" height="250" 
      style="position:absolute;left:0;top:0;pointer-events:none;"></canvas>
  </div>

  <button onclick="spin()">Girar</button>

  <div id="result"></div>
  <div id="cashier"></div>

  <script>
    const cajeros = ["Lucas", "Cami", "Facu", "Mati"];
    const premios = ["5% Extra", "10% Extra", "15% Extra", "20% Extra", "30% Extra"];

    // ðŸ”¹ Premios grandes que solo salen una vez al dÃ­a por cajero
    const premiosGrandes = ["20% Extra", "30% Extra"];

    function shuffle(array) {
      let currentIndex = array.length, randomIndex;
      while (currentIndex !== 0) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;
        [array[currentIndex], array[randomIndex]] = [
          array[randomIndex], array[currentIndex]];
      }
      return array;
    }

    // Inicializar rotaciÃ³n diaria de cajeros
    function initDailyCashiers() {
      const today = new Date().toDateString();
      let data = JSON.parse(localStorage.getItem("dailyCashiers"));
      if (!data || data.date !== today) {
        data = {
          date: today,
          order: shuffle([...cajeros]),
          index: 0,
          premiosEntregados: {}
        };
        cajeros.forEach(c => data.premiosEntregados[c] = []);
        localStorage.setItem("dailyCashiers", JSON.stringify(data));
      }
      return data;
    }

    function assignCashier() {
      let cashier = localStorage.getItem("assignedCashier");
      if (!cashier) {
        let data = initDailyCashiers();
        cashier = data.order[data.index];
        data.index = (data.index + 1) % data.order.length;
        if (data.index === 0) data.order = shuffle([...cajeros]); // rebarajar cuando se da la vuelta
        localStorage.setItem("assignedCashier", cashier);
        localStorage.setItem("dailyCashiers", JSON.stringify(data));
      }
      return cashier;
    }

    let assignedCashier = assignCashier();
    document.getElementById("cashier").innerText = "Tu cajero es: " + assignedCashier;

    // ðŸŽ¡ Dibujar ruleta
    const canvas = document.getElementById("wheelCanvas");
    const ctx = canvas.getContext("2d");
    const numSegments = premios.length;
    const anglePerSegment = (2 * Math.PI) / numSegments;

    function drawWheel() {
      for (let i = 0; i < numSegments; i++) {
        ctx.beginPath();
        ctx.moveTo(125, 125);
        ctx.arc(125, 125, 125, i * anglePerSegment, (i + 1) * anglePerSegment);
        ctx.fillStyle = i % 2 === 0 ? "#ff0" : "#f0f";
        ctx.fill();
        ctx.save();
        ctx.translate(125, 125);
        ctx.rotate(i * anglePerSegment + anglePerSegment / 2);
        ctx.fillStyle = "#000";
        ctx.font = "bold 14px Arial";
        ctx.fillText(premios[i], 40, 5);
        ctx.restore();
      }
    }
    drawWheel();

    let isSpinning = false;

    function spin() {
      if (isSpinning) return;
      isSpinning = true;

      let data = initDailyCashiers();
      let premiosCajero = data.premiosEntregados[assignedCashier];

      // Elegir premio evitando repetir grandes
      let available = premios.filter(p => !(premiosGrandes.includes(p) && premiosCajero.includes(p)));
      if (available.length === 0) available = premios;

      let premio = available[Math.floor(Math.random() * available.length)];

      if (premiosGrandes.includes(premio)) {
        data.premiosEntregados[assignedCashier].push(premio);
        localStorage.setItem("dailyCashiers", JSON.stringify(data));
      }

      // AnimaciÃ³n: girar hacia el premio elegido
      let targetIndex = premios.indexOf(premio);
      let targetAngle = (numSegments - targetIndex) * anglePerSegment;
      let rotations = 6 * 2 * Math.PI; 
      let finalAngle = rotations + targetAngle;

      let duration = 4000;
      let start = null;

      function animate(timestamp) {
        if (!start) start = timestamp;
        let progress = timestamp - start;
        let angle = easeOut(progress, 0, finalAngle, duration);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.save();
        ctx.translate(125, 125);
        ctx.rotate(angle);
        ctx.translate(-125, -125);
        drawWheel();
        ctx.restore();
        if (progress < duration) {
          requestAnimationFrame(animate);
        } else {
          document.getElementById("result").innerText = "ðŸŽ‰ Ganaste: " + premio;
          launchConfetti();
          isSpinning = false;
        }
      }
      requestAnimationFrame(animate);
    }

    function easeOut(t, b, c, d) {
      t /= d;
      t--;
      return c * (t * t * t + 1) + b;
    }

    // ðŸŽŠ Confetti simple
    const confettiCanvas = document.getElementById("confetti");
    const confettiCtx = confettiCanvas.getContext("2d");
    function launchConfetti() {
      let pieces = Array.from({length: 50}, () => ({
        x: Math.random() * 250,
        y: Math.random() * 250,
        r: Math.random() * 6 + 4,
        d: Math.random() * 250,
        color: `hsl(${Math.random()*360},100%,50%)`,
        tilt: Math.random() * 10 - 10
      }));
      let angle = 0;
      function draw() {
        confettiCtx.clearRect(0,0,250,250);
        angle += 0.01;
        pieces.forEach(p => {
          p.y += 2;
          p.x += Math.sin(angle) * 2;
          confettiCtx.beginPath();
          confettiCtx.arc(p.x, p.y, p.r, 0, Math.PI*2, false);
          confettiCtx.fillStyle = p.color;
          confettiCtx.fill();
        });
      }
      let interval = setInterval(draw, 20);
      setTimeout(() => clearInterval(interval), 3000);
    }
  </script>
</body>
</html>
