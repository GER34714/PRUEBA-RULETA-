<script>
// Cajeros y premios
let cashiers = [
  {nombre:'Lucas',telefono:'5491171334027', prizes:[
    "10% extra (con carga min)",
    "15% extra (con carga min)",
    "20% extra (con carga min)",
    "30% extra (en mi 2da carga)",
    "1000 fichas (sin carga,no ret.)",
    "500 fichas (sin carga,no ret.)",
    "300 fichas (sin carga,no ret.)"
  ]},
  {nombre:'Cami',telefono:'5491156349123', prizes:[
    "10% extra (con carga min)",
    "15% extra (con carga min)",
    "20% extra (con carga min)",
    "30% extra (en mi 2da carga)",
    "1000 fichas (sin carga,no ret.)",
    "500 fichas (sin carga,no ret.)",
    "300 fichas (sin carga,no ret.)"
  ]},
  {nombre:'Joaki',telefono:'5491123365501', prizes:[
    "10% extra (con carga min)",
    "15% extra (con carga min)",
    "20% extra (con carga min)",
    "30% extra (en mi 2da carga)",
    "1000 fichas (sin carga,no ret.)",
    "500 fichas (sin carga,no ret.)",
    "300 fichas (sin carga,no ret.)"
  ]},
  {nombre:'Facu',telefono:'5491125127839', prizes:[
    "10% extra (con carga min)",
    "15% extra (con carga min)",
    "20% extra (con carga min)",
    "30% extra (en mi 2da carga)",
    "1000 fichas (sin carga,no ret.)",
    "500 fichas (sin carga,no ret.)",
    "300 fichas (sin carga,no ret.)"
  ]}
];

// ID único usuario
function getUserId() {
  let uid = localStorage.getItem('userId');
  if(!uid){
    uid = 'user_' + Math.random().toString(36).substr(2,9);
    localStorage.setItem('userId', uid);
  }
  return uid;
}
const userId = getUserId();

// Asignar cajero
function getAssignedCashier() {
  let assignments = JSON.parse(localStorage.getItem('cashierAssignments')) || {};
  if(assignments[userId]) {
    return cashiers.find(c => c.nombre === assignments[userId]);
  }

  let usedToday = Object.values(assignments);
  let remaining = cashiers.filter(c => !usedToday.includes(c.nombre));

  if(remaining.length === 0){
    remaining = [...cashiers];
    assignments = {};
  }

  const assigned = remaining[Math.floor(Math.random()*remaining.length)];
  assignments[userId] = assigned.nombre;
  localStorage.setItem('cashierAssignments', JSON.stringify(assignments));

  return assigned;
}

// Datos del usuario
let userData = JSON.parse(localStorage.getItem('userData')) || {lastSpin:0,lastPrize:null};
let dailyCount = Math.floor(Math.random()*500+100);

const spinBtn = document.getElementById('spinButton');
const dailyCounter = document.getElementById('dailyCounter');
const popup = document.getElementById('winnerPopup');
const winnerMsg = document.getElementById('winnerMessage');
const winnerDate = document.getElementById('winnerDate');
const winnerBtn = document.getElementById('winnerButton');
const canvas = document.getElementById('wheelCanvas');
const ctx = canvas.getContext('2d');
const wheelRadius = canvas.width/2;
let angle = 0;
const colors=["#ff0000","#ff9900","#ffff00","#00ff00","#00ffff","#0000ff","#ff00ff"];

// Dibujar ruleta
function drawWheel(){
  const num = 7, arc = 2*Math.PI/num;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let i=0;i<num;i++){
    const start = i*arc, end = start+arc;
    ctx.beginPath();
    ctx.moveTo(wheelRadius,wheelRadius);
    ctx.arc(wheelRadius,wheelRadius,wheelRadius,start+angle,end+angle);
    ctx.fillStyle = colors[i%colors.length];
    ctx.fill();
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2;
    ctx.stroke();
    ctx.save();
    ctx.translate(wheelRadius,wheelRadius);
    ctx.rotate(start+arc/2+angle);
    ctx.fillStyle = '#000';
    ctx.font = 'bold 20px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(String(i+1), wheelRadius/2, 10);
    ctx.restore();
  }
}
drawWheel();

// Confetti
const confCanvas = document.getElementById('confetti');
const confCtx = confCanvas.getContext('2d');
confCanvas.width = popup.offsetWidth;
confCanvas.height = popup.offsetHeight;
let confettiParticles=[];
function launchConfetti(){
  confettiParticles=[];
  for(let i=0;i<100;i++){
    confettiParticles.push({
      x: Math.random()*confCanvas.width,
      y: Math.random()*confCanvas.height-50,
      r: Math.random()*6+2,
      dx: (Math.random()-0.5)*4,
      dy: Math.random()*4+1,
      color: `hsl(${Math.random()*360},100%,50%)`
    })
  }
  animateConfetti();
}
function animateConfetti(){
  confCtx.clearRect(0,0,confCanvas.width,confCanvas.height);
  confettiParticles.forEach(p=>{
    p.x += p.dx; p.y += p.dy;
    if(p.y>confCanvas.height) p.y=0;
    confCtx.beginPath();
    confCtx.arc(p.x,p.y,p.r,0,Math.PI*2);
    confCtx.fillStyle = p.color;
    confCtx.fill();
  });
  if(confettiParticles.length>0){
    requestAnimationFrame(animateConfetti);
    confettiParticles = confettiParticles.filter(p=>p.y<confCanvas.height);
  }
}

// Obtener premio por cajero con control de premios grandes
function getPrizeForCashier(cashier){
  const key = `prizes_${cashier.nombre}`;
  let prizeArray = JSON.parse(localStorage.getItem(key)) || [...cashier.prizes];

  const today = new Date().toDateString();
  const bigPrizes = ["20% extra (con carga min)","30% extra (en mi 2da carga)"];
  let usedBigPrizes = JSON.parse(localStorage.getItem('usedBigPrizes')) || {};
  if(!usedBigPrizes[today]) usedBigPrizes[today] = {};
  if(!usedBigPrizes[today][cashier.nombre]) usedBigPrizes[today][cashier.nombre] = [];

  let prizeIndex = 0;
  while(bigPrizes.includes(prizeArray[prizeIndex]) && usedBigPrizes[today][cashier.nombre].includes(prizeArray[prizeIndex])){
    prizeIndex++;
    if(prizeIndex >= prizeArray.length) break;
  }

  let prize = prizeArray.splice(prizeIndex,1)[0];

  if(bigPrizes.includes(prize)){
    usedBigPrizes[today][cashier.nombre].push(prize);
    localStorage.setItem('usedBigPrizes', JSON.stringify(usedBigPrizes));
  }

  prizeArray.push(prize);
  localStorage.setItem(key, JSON.stringify(prizeArray));

  return prize;
}

// Control de giro cada 24 hs
const ms24h = 24*60*60*1000;
const nowTime = Date.now();
if(nowTime - userData.lastSpin < ms24h && userData.lastPrize){
  spinBtn.disabled = true;
  popup.classList.add('show');
  winnerMsg.textContent = `¡Ganaste: ${userData.lastPrize}!`;
  winnerDate.textContent = `Fecha y hora: ${new Date(userData.lastSpin).toLocaleString()}`;
  winnerBtn.style.display = 'inline-block';
}

// Giro de ruleta
spinBtn.addEventListener('click',()=>{
  spinBtn.disabled = true;
  const assignedCashier = getAssignedCashier();
  const prize = getPrizeForCashier(assignedCashier);
  const spinAngle = Math.random()*Math.PI*4+Math.PI*4;
  const duration = 3000;
  const start = performance.now();
  const startAngle = angle;

  function animate(time){
    let elapsed = time-start;
    if(elapsed>duration) elapsed = duration;
    const progress = elapsed/duration;
    angle = startAngle + spinAngle*easeOutCubic(progress);
    drawWheel();
    if(elapsed<duration) requestAnimationFrame(animate);
    else finishSpin();
  }
  requestAnimationFrame(animate);

  function finishSpin(){
    const now = new Date();
    const nowStr = now.toLocaleString();

    winnerMsg.textContent = `¡Ganaste: ${prize}!`;
    winnerDate.textContent = `Fecha y hora: ${nowStr}`;
    popup.classList.add('show');
    winnerBtn.style.display = 'inline-block';
    launchConfetti();

    dailyCount++;
    dailyCounter.textContent=`Hoy ya giraron ${dailyCount} personas.`;

    userData.lastSpin = now.getTime();
    userData.lastPrize = prize;
    localStorage.setItem('userData', JSON.stringify(userData));

    winnerBtn.onclick = ()=>{
      const mensaje = encodeURIComponent(`Hola ${assignedCashier.nombre}! Gané ${prize} el ${nowStr} y quisiera reclamarlo. Muchas gracias`);
      const url = `https://wa.me/${assignedCashier.telefono}?text=${mensaje}`;
      window.open(url,'_blank');
    }
  }
});

function easeOutCubic(t){return 1-Math.pow(1-t,3);}
</script>
